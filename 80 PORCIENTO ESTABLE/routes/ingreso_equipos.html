<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Ingreso de Equipos</title>
    
    <style>
        body {
            background-image: url('image_home.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: Arial, sans-serif;
            margin: 0;
       
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        main {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(120vh - 60px); /* Ajusta el espacio para el header */
            padding: 20px;
        }

        .form-container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .form-group {
            text-align: center;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea,
        .form-group input[type="date"] {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group textarea {
            height: 100px;
        }

        .direccion-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .direccion-container select,
        .direccion-container input {
            padding: 8px;
            font-size: 16px;
            width: 130px;
            box-sizing: border-box;
        }

        .direccion-label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .direccion-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        .direccion-group > div {
            margin-right: 10px;
            text-align: center;
        }

        .form-group input[type="checkbox"] {
            transform: scale(1.5);
        }

        .direccion-result-container {
            text-align: center;
            margin-top: 10px;
        }

        .direccion-result-container h2 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .direccion-result-container #resultado-direccion {
            font-size: 15px;
            font-weight: bold;
        }

        .tarjeta-section {
            margin-top: 15px;
        }

        .tarjeta-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .tarjeta-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .tarjeta-container label {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .tarjeta-container label:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .tarjeta-container input[type="number"] {
            width: 60px;
            margin-top: 5px;
            text-align: center;
        }

        .tarjeta-container input[type="checkbox"] {
            margin-bottom: 5px;
        }

        .button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .flex-container {
            display: flex;
            gap: 15px;
        }

        .flex-container > .form-group {
            flex: 1;
        }

        .flex-container > .form-group select {
            width: 100%;
        }

        h1, h2 {
            text-align: center;
        }

        .nombre-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nombre-container .form-group {
            flex: 1;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Formulario de Ingreso de Equipos</h1>
    </header>

    <main>
        <div class="form-container">
            <form id="equipoForm" action="/procesar_formulario" method="post">
                <div class="form-group">
                    
               
                    <label for="direccion">Ingrese la dirección procedente del equipo</label>
                    <br>
                
                    <div class="direccion-group">
                        <div class="direccion-container">
                            <div>
                                <label for="direccion_tipo_1" class="direccion-label">Tipo 1</label>
                                <select id="direccion_tipo_1" name="direccion_tipo_1" required>
                                    <option value="" disabled selected>Seleccionar</option>
                                    <option value="C">Calle (C)</option>
                                    <option value="D">Diagonal (D)</option>
                                    <option value="A">Avenida (A)</option>
                                    <option value="K">Carrera (K)</option>
                                    <option value="T">Troncal (T)</option>
                                </select>
                            </div>
                            <div>
                                <label for="direccion_numero_1" class="direccion-label">Número 1</label>
                                <input type="text" id="direccion_numero_1" name="direccion_numero_1" maxlength="2" required>
                            </div>
                            <div>
                                <label for="direccion_tipo_2" class="direccion-label">Tipo 2</label>
                                <select id="direccion_tipo_2" name="direccion_tipo_2">
                                    <option value="" disabled selected>Seleccionar</option>
                                    <option value="C">Calle (C)</option>
                                    <option value="D">Diagonal (D)</option>
                                    <option value="A">Avenida (A)</option>
                                    <option value="K">Carrera (K)</option>
                                    <option value="T">Troncal (T)</option>
                                </select>
                            </div>
                            <div>
                                <label for="direccion_numero_2" class="direccion-label">Número 2</label>
                                <input type="text" id="direccion_numero_2" name="direccion_numero_2" maxlength="2">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="direccion-result-container">
                    <div id="resultado-direccion">Dirección incompleta</div>
                    <br>
                    <hr>
                </div>

                <div class="flex-container">
                    <div class="form-group">
                        <label for="tipo_movimiento">Tipo de Movimiento</label>
                        <select id="tipo_movimiento" name="tipo_movimiento" required>
                            <option value="entrada">Entrada</option>
                            <option value="salida">Salida</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="equipos">Tipo de equipo</label>
                        <select id="equipos" name="equipos" required>
                            <option value="" disabled selected>Seleccionar</option>
                            <option value="MP">MP</option>
                            <option value="MF">MF</option>
                            <option value="SOLUTRAFIC">SOLUTRAFIC</option>
                            <option value="TUMOTRAFIC">TUMOTRAFIC</option>
                            <option value="WISE">WISE</option>
                            <option value="SX">SX</option>
                            <option value="C900">C900</option>
                            <option value="CROSS">CROSS</option>
                            <option value="IMATIC">IMATIC</option>
                            <option value="MINICOVA">MINICOVA</option>
                            <option value="SAWRCO">SWARCO</option>
                        </select>
                    </div>
                </div>

                <div class="tarjeta-section">
                    <h2>Seleccione las tarjetas correspondientes</h2>
                    <div class="tarjeta-container" id="tarjetas-container"></div>
                </div>

                <div class="nombre-container">
                    <div class="form-group">
                        <br>
                        <br>
                        <label for="nombre_entrega">Nombre de Quien Entrega</label>
                        <select id="nombre_entrega" name="nombre_entrega" required>
                            <option value="" disabled selected>Seleccione</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <br>
                        <br>
                        <label for="nombre_recibe">Nombre de Quien Recibe</label>
                        <select id="nombre_recibe" name="nombre_recibe" required>
                            <option value="" disabled selected>Seleccione</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="observaciones">Observaciones</label>
                    <textarea id="observaciones" name="observaciones"></textarea>
                </div>

                <div class="form-group">
                    <label for="fecha_notificacion">Fecha de Notificación</label>
                    <input type="date" id="fecha_notificacion" name="fecha_notificacion" required>
                </div>

                <div class="form-group">
                    <button type="submit" class="button">Guardar</button>
                    <button class="button" onclick="window.history.back()">Regresar</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        function populateSelect(url, selectId) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const selectElement = document.getElementById(selectId);
                    selectElement.innerHTML = ''; // Limpiar opciones existentes
                    data.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function updateNames(tipoMovimiento) {
            let urlTecnicos;
            let urlIngenieros;

            if (tipoMovimiento === 'entrada') {
                urlTecnicos = '/api/tecnicos';
                urlIngenieros = '/api/ingenieros';
                document.getElementById('nombre_entrega').setAttribute('placeholder', 'Seleccione un técnico');
                document.getElementById('nombre_recibe').setAttribute('placeholder', 'Seleccione un ingeniero');
            } else if (tipoMovimiento === 'salida') {
                urlTecnicos = '/api/ingenieros';
                urlIngenieros = '/api/tecnicos';
                document.getElementById('nombre_entrega').setAttribute('placeholder', 'Seleccione un ingeniero');
                document.getElementById('nombre_recibe').setAttribute('placeholder', 'Seleccione un técnico');
            }

            populateSelect(urlTecnicos, 'nombre_entrega');
            populateSelect(urlIngenieros, 'nombre_recibe');
        }



// OBTENER INFORMACIÓN DEL FORMULARIO

function obtenerDatosFormulario() {
    const tipoMovimiento = document.getElementById('tipo_movimiento').value;
    const nombreEntrega = document.getElementById('nombre_entrega').value;
    const nombreRecibe = document.getElementById('nombre_recibe').value;
    const tipoEquipo = document.getElementById('equipos').value;
    const observaciones = document.getElementById('observaciones').value; // INGRESAR EL PREDIAGNOSTICO DEL EQUIPO
    const estado = 'Notificado';
    const fechaNotificacion = document.getElementById('fecha_notificacion').value; // INGRESAR EL PREDIAGNOSTICO DEL EQUIPO
    const tarjetas = Array.from(document.querySelectorAll('input[name="tarjetas"]:checked')).map(input => {
    
    
        return {
            tarjeta: input.value,
            cantidad: document.getElementById(`cantidad${input.value}`).value
        };
    });

    return {
        tipo_movimiento: tipoMovimiento,
        tipo_equipo: tipoEquipo,
        tarjetas_ingresadas: tarjetas,
        nombre_entrega: nombreEntrega,
        nombre_recibe: nombreRecibe,
        observaciones:observaciones,
        estado:estado,
        fecha_notificacion:fechaNotificacion
    };
}



// Función para actualizar la dirección resultante GUARDAR EN COLUMNA
function actualizarDireccion() {
    const tipoDireccion1 = document.getElementById('direccion_tipo_1').value;
    const numeroDireccion1 = document.getElementById('direccion_numero_1').value;
    const tipoDireccion2 = document.getElementById('direccion_tipo_2').value;
    const numeroDireccion2 = document.getElementById('direccion_numero_2').value;

    let resultado = '';

    if (tipoDireccion1 && numeroDireccion1) {
        resultado += tipoDireccion1 + "" + numeroDireccion1;
    }
    if (tipoDireccion2 && numeroDireccion2) {
        resultado += "" + tipoDireccion2 + "" + numeroDireccion2;
    }

    // Guardar la dirección en la variable global
    direccionResultante = resultado || "Dirección incompleta";

    // Actualizar el campo de resultado en el formulario
    document.getElementById('resultado-direccion').textContent = direccionResultante;
    document.getElementById('resultado-direccion').style.color = direccionResultante === "Dirección incompleta" ? 'red' : 'green';
}

// Configurar el evento de clic para el botón de guardar
document.querySelector('.button').addEventListener('click', function (event) {
    event.preventDefault(); // Evitar el envío predeterminado del formulario

    const datosFormulario = obtenerDatosFormulario();
    const direccionResultante = document.getElementById('resultado-direccion').textContent;

    // Añadir la dirección al objeto de datos
    datosFormulario.direccion_resultante = direccionResultante;

    // Enviar los datos al servidor en formato JSON
    fetch('/guardar_equipo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datosFormulario)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP error! Status: ${response.status}, Message: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Datos guardados correctamente.');
        } else {
            alert('Error al guardar los datos: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar los datos: ' + error.message);
    });
});

// Añadir listeners para actualizar la dirección cuando cambien los campos
document.querySelectorAll('.direccion-container select, .direccion-container input').forEach(el => {
    el.addEventListener('change', actualizarDireccion);
});


// Añadir listeners para actualizar la dirección cuando cambien los campos
document.querySelectorAll('.direccion-container select, .direccion-container input').forEach(el => {
    el.addEventListener('change', actualizarDireccion);
});


        function inicializarFormulario() {
            // Manejar cambios en los campos de dirección
            document.getElementById('direccion_tipo_1').addEventListener('change', actualizarDireccion);
            document.getElementById('direccion_numero_1').addEventListener('input', actualizarDireccion);
            document.getElementById('direccion_tipo_2').addEventListener('change', actualizarDireccion);
            document.getElementById('direccion_numero_2').addEventListener('input', actualizarDireccion);

            // Manejar cambios en el tipo de equipo
            document.getElementById('equipos').addEventListener('change', function () {
                const tipoEquipo = this.value;
                const tarjetasContainer = document.getElementById('tarjetas-container');
                tarjetasContainer.innerHTML = ''; // Limpiar tarjetas existentes

                let tarjetas = [];

                switch (tipoEquipo) {
                    case 'C900':
                        tarjetas = ['BBX', 'BSE', 'MDU', 'LSC', 'PHP'];
                        break;
                    case 'MF':
                        tarjetas = ["MC1", "GS1", "TSZ", "TSD"];
                        break;
                    case 'MINICOVA':
                        tarjetas = ["TARJETA INTEGRADA"];
                        break;
                    case 'SOLUTRAFIC':
                        tarjetas = ["CPU", "TARJETAS POTENCIA", "TARJETA EXPANSION", "BASE PROCESADOR"];
                        break;
                    case 'TUMOTRAFIC':
                        tarjetas = ["CPU", "POTENCIA"];
                        break;
                    case 'MP':
                        tarjetas = ["PXA", "A32", "U16", "LPG", "LPE", "SCR", "ZEP"];
                        break;
                    case 'WISE':
                        tarjetas = ['TARJETA W4', 'TARJETA W7', 'TARJETA W8', 'FUENTE 12V -5A', 'PROTECTOR VOLTAJE'];
                        break;
                    case 'IMATIC':
                        tarjetas = ['PROCESADOR', 'CPU', 'TARJETA POTENCIA', 'TARJETA DE EXPANSIÓN'];
                        break;
                    case 'SX':
                        tarjetas = ["CTB", "CBU", "CPDH", "CDBH", "LSHS", "OMC", "FUENTA"];
                        break;
                    case 'CROSS':
                        tarjetas = ['TARJETA POTENCIA', 'PROCESADOR', 'FUENTE'];
                        break;
                }

                tarjetas.forEach(tarjeta => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" id="${tarjeta}" name="tarjetas" value="${tarjeta}">
                        ${tarjeta}
                        <input type="number" id="cantidad${tarjeta}" name="cantidad${tarjeta}" value="1" min="1" max="999">
                    `;
                    tarjetasContainer.appendChild(label);
                });

                tarjetasContainer.style.display = tarjetas.length > 0 ? 'flex' : 'none';
            });

            // Manejar cambios en el tipo de movimiento
            document.getElementById('tipo_movimiento').addEventListener('change', function () {
                const tipoMovimiento = this.value;
                updateNames(tipoMovimiento);
            });

            // Inicializar con tipo de movimiento 'entrada' por defecto
            updateNames('entrada');

            // Configurar la fecha de notificación
            const fechaNotificacion = new Date().toISOString().slice(0, 10);
            document.getElementById('fecha_notificacion').value = fechaNotificacion;

            // Actualizar dirección al cargar la página
            actualizarDireccion();
        }

        // Inicializar el formulario al cargar la página
        window.addEventListener('load', inicializarFormulario);
    </script>
</body>
</html>
